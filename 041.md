obront

medium

# guardEntries does not protect against reentrancy

## Summary

The `guardEntries` variable is intended to protect against reentrancy, but it's used incorrect and doesn't accomplish that goal.

## Vulnerability Detail

The protocol has a `guardEntries` variable. It is incremented in `checkTransaction()` (before a transaction is executed) and decremented in `checkAfterExecution()` (after the transaction has completed).

The only protection it provides is in its risk of underflowing, explained in the comments as:

> // leave checked to catch underflows triggered by re-erntry attempts

However, any attempt to reenter and send an additional transaction midstream of another transaction would first trigger the `checkTransaction()` function. This would increment `_guardEntries` and would lead to it not underflowing.

As it is currently designed, this system doesn't provide the intended protection against reentrancy.

## Impact

The intended reentrancy protection does not work as expected, opening up the unexpected risk of reentrancy attacks with an unknown surface area of allowing safe functions to reenter and create new safe transactions.

## Code Snippet

https://github.com/Hats-Protocol/hats-zodiac/blob/9455cc0957762f5dbbd8e62063d970199109b977/src/HatsSignerGateBase.sol#L445-L529

## Tool used

Manual Review

## Recommendation

Use a more typical reentrancy guard format, checking to ensure `_guardEntries == 0` at the top of `checkTransaction()`.